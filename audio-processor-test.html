<!DOCTYPE html>
<html>
<head>
  <title>Audio Processor Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
    }
    button {
      background-color: #4CAF50;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin: 10px 0;
    }
    button:hover {
      background-color: #45a049;
    }
    #result {
      background-color: #f5f5f5;
      padding: 15px;
      border-radius: 4px;
      margin-top: 20px;
      white-space: pre-wrap;
      font-family: monospace;
    }
    .loading {
      color: #0066cc;
    }
    .success {
      color: #4CAF50;
    }
    .error {
      color: #f44336;
    }
  </style>
</head>
<body>
  <h1>Audio Processor Test</h1>
  
  <div>
    <h3>Test Parameters:</h3>
    <p><strong>Audio URL:</strong> <span id="audioUrl"></span></p>
    <p><strong>Background Music URL:</strong> <span id="bgMusicUrl"></span></p>
    <p><strong>Audio Processor Service URL:</strong> <span id="processorUrl"></span></p>
  </div>
  
  <button id="testBtn">Test Audio Processor</button>
  <button id="schemaBtn">Check API Schema</button>
  <button id="altTestBtn">Test Alternate Format</button>
  <div id="status"></div>
  <pre id="result"></pre>

  <script>
    // The URLs to test
    const audioUrl = "https://gbypnkiziennhzqbhqtr.supabase.co/storage/v1/object/public/podcast_audio/podcast_audio/raw/raw_podcast_99e559e0-8b66-4ac8-a363-5d3090d50bd4_20250317T195817840Z.mp3";
    const backgroundMusicUrl = "https://gbypnkiziennhzqbhqtr.supabase.co/storage/v1/object/public/podcast_music//default_background.mp3";
    const processorUrl = "https://bts-radiology-production.up.railway.app";
    
    // Display the URLs on the page
    document.getElementById('audioUrl').textContent = audioUrl;
    document.getElementById('bgMusicUrl').textContent = backgroundMusicUrl;
    document.getElementById('processorUrl').textContent = processorUrl;
    
    // Add schema check functionality
    document.getElementById('schemaBtn').addEventListener('click', async () => {
      const statusEl = document.getElementById('status');
      const resultEl = document.getElementById('result');
      
      statusEl.innerHTML = '<p class="loading">Checking API schema...</p>';
      resultEl.textContent = '';
      
      try {
        // Try to fetch the OpenAPI schema if available
        const schemaResponse = await fetch(`${processorUrl}/openapi.json`);
        if (schemaResponse.ok) {
          const schemaData = await schemaResponse.json();
          statusEl.innerHTML = '<p class="success">Successfully retrieved API schema</p>';
          resultEl.textContent = 'OpenAPI Schema:\n' + JSON.stringify(schemaData, null, 2);
          return;
        }
        
        // If OpenAPI schema isn't available, try docs
        const docsResponse = await fetch(`${processorUrl}/docs`);
        if (docsResponse.ok) {
          statusEl.innerHTML = '<p class="success">API documentation available at ' + processorUrl + '/docs</p>';
          resultEl.textContent = 'Please visit ' + processorUrl + '/docs to see the API documentation';
          window.open(`${processorUrl}/docs`, '_blank');
          return;
        }
        
        // If none of the above worked, try a modified request
        statusEl.innerHTML = '<p class="loading">Testing simplified request...</p>';
        
        // Try a minimal request to see what error we get
        const simpleResponse = await fetch(`${processorUrl}/mix-audio/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            audio_url: audioUrl
          })
        });
        
        const responseData = await simpleResponse.json();
        statusEl.innerHTML = `<p class="error">Test failed with status: ${simpleResponse.status}</p>`;
        resultEl.textContent = 'Error response which may contain schema hints:\n' + JSON.stringify(responseData, null, 2);
        
      } catch (error) {
        statusEl.innerHTML = `<p class="error">Error: ${error.message}</p>`;
        resultEl.textContent = error.stack || error.message;
      }
    });
    
    document.getElementById('testBtn').addEventListener('click', async () => {
      const statusEl = document.getElementById('status');
      const resultEl = document.getElementById('result');
      
      statusEl.innerHTML = '<p class="loading">Testing audio processor... This may take a minute...</p>';
      resultEl.textContent = '';
      
      try {
        // First, check if the audio processor is running
        const healthResponse = await fetch(processorUrl);
        if (!healthResponse.ok) {
          throw new Error(`Audio processor service unavailable: ${healthResponse.status} ${healthResponse.statusText}`);
        }
        
        const healthData = await healthResponse.json();
        resultEl.textContent = 'Health check response:\n' + JSON.stringify(healthData, null, 2) + '\n\nNow testing mixing function...';
        
        // Now test the audio mixing endpoint
        const mixingResponse = await fetch(`${processorUrl}/mix-audio/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            audio_url: audioUrl,
            background_music_url: backgroundMusicUrl,
            intro_duration: 8000,
            outro_duration: 8000,
            background_volume: -12,
            storage_bucket: "podcast_audio",
            filename_prefix: "processed_test_",
            supabase_config: {
              supabase_url: "https://gbypnkiziennhzqbhqtr.supabase.co",
              supabase_key: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdieXBua2l6aWVubmh6cWJocXRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE2MzQ1Mzg0NjAsImV4cCI6MTk0OTExNDQ2MH0._CSGN5Q5tRzVyxjM0Z_C5uZhvok0GhVOx8WhXLOFEAo", // This is a public anon key
              episode_id: "test-episode-id"
            }
          })
        });
        
        const responseData = await mixingResponse.json();
        
        if (mixingResponse.ok && responseData.success) {
          statusEl.innerHTML = '<p class="success">Test successful! Audio processor is working correctly.</p>';
        } else {
          statusEl.innerHTML = `<p class="error">Test failed with status: ${mixingResponse.status}</p>`;
        }
        
        resultEl.textContent = 'Response:\n' + JSON.stringify(responseData, null, 2);
      } catch (error) {
        statusEl.innerHTML = `<p class="error">Error: ${error.message}</p>`;
        resultEl.textContent = error.stack || error.message;
      }
    });
    
    // Add alternate test with different payload structure
    document.getElementById('altTestBtn').addEventListener('click', async () => {
      const statusEl = document.getElementById('status');
      const resultEl = document.getElementById('result');
      
      statusEl.innerHTML = '<p class="loading">Testing with alternate payload format...</p>';
      resultEl.textContent = '';
      
      try {
        // First, check if the audio processor is running
        const healthResponse = await fetch(processorUrl);
        if (!healthResponse.ok) {
          throw new Error(`Audio processor service unavailable: ${healthResponse.status} ${healthResponse.statusText}`);
        }
        
        const healthData = await healthResponse.json();
        resultEl.textContent = 'Health check response:\n' + JSON.stringify(healthData, null, 2) + '\n\nNow testing with alternate format...';
        
        // Use the structure from process-podcast-audio/index.ts function
        const alternateResponse = await fetch(`${processorUrl}/mix-audio/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            "audio_url": audioUrl,
            "background_music_url": backgroundMusicUrl,
            "intro_duration": 8000,
            "outro_duration": 8000,
            "background_volume": -12
          })
        });
        
        const responseData = await alternateResponse.json();
        
        if (alternateResponse.ok && responseData.success) {
          statusEl.innerHTML = '<p class="success">Test successful with alternate format!</p>';
        } else {
          statusEl.innerHTML = `<p class="error">Test failed with status: ${alternateResponse.status}</p>`;
        }
        
        resultEl.textContent += '\n\nResponse:\n' + JSON.stringify(responseData, null, 2);
      } catch (error) {
        statusEl.innerHTML = `<p class="error">Error: ${error.message}</p>`;
        resultEl.textContent = error.stack || error.message;
      }
    });
  </script>
</body>
</html> 